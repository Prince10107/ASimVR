#VRML V2.0 utf8

# Component and Profile declarations (standard)
# component USE_RigidBodies 1
# component USE_Shaders 1
# component USE_Scripting 1
# profile Interactive

WorldInfo {
  title "ASimVR Polymerization CSTR Reactor"
}

# --- TOP-LEVEL EVENTINS (Simulink Inputs) ---
# These are the names Allan will use in the VR Sink block in Simulink.
eventIn SFColor set_reactor_color
eventIn SFFloat set_reactor_transparency
eventIn SFVec3f set_liquid_level
eventIn SFFloat set_liquid_transparency
eventIn SFRotation set_agitator_rotation
eventIn SFRotation set_valve_knob_rotation
eventIn SFVec3f set_temp_sensor_scale
eventIn SFVec3f set_press_sensor_scale


PROTO Valve [ # Reusable Valve component
  field SFVec3f position 0 0 0
  field SFFloat size 0.15
]
{
  Transform { translation IS position children [ Shape { appearance Appearance { material Material { diffuseColor 0.9 0.5 0.1 specularColor 1 1 1 shininess 0.2 } } geometry Sphere { radius IS size } } ] }
}

# Material Definitions (standard)
DEF REACTOR_BODY_MATERIAL Material { diffuseColor 0.6 0.8 0.9 specularColor 0.8 0.8 0.8 shininess 0.1 }
DEF PIPE_MATERIAL Material { diffuseColor 0.4 0.4 0.4 specularColor 0.7 0.7 0.7 shininess 0.1 }
DEF AGITATOR_BLADE_MATERIAL Material { diffuseColor 0.8 0.2 0.2 specularColor 0.9 0.9 0.9 shininess 0.1 }
DEF AGITATOR_SHAFT_MATERIAL Material { diffuseColor 0.9 0.9 0.0 specularColor 0.9 0.9 0.9 shininess 0.1 }
DEF SENSOR_MATERIAL Material { diffuseColor 0.2 0.7 0.2 specularColor 0.8 0.8 0.8 shininess 0.1 }
DEF BASE_MATERIAL Material { diffuseColor 0.3 0.3 0.3 specularColor 0.6 0.6 0.6 shininess 0.1 }

DEF DRAIN_CONE Transform { translation 0 -3.3 0 children [ Shape { appearance Appearance { material USE PIPE_MATERIAL } } geometry Cone { bottomRadius 0.4 height 0.8 } ] }

# PROTO Definition for Dynamic Reactor Body - Solved Base64 & IS for internal material
PROTO DynamicReactorBody [
  field SFColor reactor_color_input 0.6 0.8 0.9
  field SFFloat reactor_transparency_input 0.0
]
{
  Transform {
    translation 0 0 0
    children [
      Shape {
        appearance Appearance {
          material DEF DYNAMIC_REACTOR_BODY_MATERIAL_NODE Material { # DEF for ROUTE target
            diffuseColor IS reactor_color_input
            transparency IS reactor_transparency_input
            specularColor 0.8 0.8 0.8 shininess 0.1
          }
        }
        geometry Cylinder { height 5.0 radius 2.0 }
      }
    ]
  }
}

# --- CRITICAL CORRECTION: REACTOR BODY INSTANTIATION ---
# This places the reactor in the scene and exposes its PROTO fields for routing.
DEF REACTOR_BODY_INSTANCE DynamicReactorBody { }

# Agitator - Now ready for dynamic rotation via ROUTE
DEF AGITATOR Transform {
  translation 0 1 0
  rotation 0 1 0 0 # Default, will be routed
  children [
    Transform { translation 0 1.5 0 children [ Shape { appearance Appearance { material USE AGITATOR_SHAFT_MATERIAL } geometry Cylinder { height 3.0 radius 0.1 } } ] }
    Transform { translation 0 0 0 rotation 0 1 0 0.785 children [ Shape { appearance Appearance { material USE AGITATOR_BLADE_MATERIAL } geometry Box { size 1.5 0.1 0.5 } } ] }
    Transform { translation 0 0 0 rotation 0 1 0 2.356 children [ Shape { appearance Appearance { material USE AGITATOR_BLADE_MATERIAL } geometry Box { size 1.5 0.1 0.5 } } ] }
  ]
}

# LIQUID - Now ready for dynamic level and transparency via ROUTE
DEF LIQUID Transform {
  translation 0 -1 0 # Default, will be routed for level
  children [
    Shape {
      appearance Appearance {
        material DEF LIQUID_MATERIAL_NODE Material { # DEF for ROUTE target
          diffuseColor 0.2 0.6 1.0
          transparency 0.5 # Default, will be routed for transparency
        }
      }
      geometry Cylinder { height 2.0 radius 1.9 }
    }
  ]
}

# Pipes (standard)
DEF INLET_PIPE Transform { translation -2.0 2.0 0 rotation 0 0 1 1.57 children [ Valve { position 0 0 0.5 size 0.15 } Shape { appearance Appearance { material USE PIPE_MATERIAL } geometry Cylinder { height 1.0 radius 0.2 } } Transform { translation 0 0 0.5 children [ Shape { appearance Appearance { material USE PIPE_MATERIAL } geometry Sphere { radius 0.15 } } ] } ] }

# VALVE_KNOB - Now ready for dynamic rotation via ROUTE
DEF VALVE_KNOB Transform {
  translation -2.0 2.8 0
  rotation 0 1 0 0 # Default, will be routed
  children [ Shape { appearance Appearance { material USE PIPE_MATERIAL } geometry Sphere { radius 0.2 } } ]
}

DEF OUTLET_PIPE Transform { translation 2.0 -2.0 0 rotation 0 0 1 1.57 children [ Valve { position 0 0 -0.6 size 0.15 } Shape { appearance Appearance { material USE PIPE_MATERIAL } geometry Cylinder { height 1.0 radius 0.2 } } Transform { translation 0 0 -0.6 children [ Shape { appearance Appearance { material USE PIPE_MATERIAL } geometry Sphere { radius 0.15 } } ] } ] }

# Temperature Sensor - Now ready for dynamic scale via ROUTE
DEF TEMP_SENSOR Transform {
  translation 0 0 2.2
  scale 1 1 1 # Default, will be routed
  children [
    Shape { appearance Appearance { material USE SENSOR_MATERIAL } geometry Sphere { radius 0.2 } }
    Transform { translation 0 0 -0.5 children [ Shape { appearance Appearance { material USE SENSOR_MATERIAL } geometry Cylinder { height 1.0 radius 0.05 } } ] }
  ]
}

DEF SENSOR_HOUSING Transform { translation 0 0 2.2 children [ Inline { url "https://raw.githubusercontent.com/Prince10107/ASimVR/main/housing.wrl" } ] }

# Pressure Sensor - Now ready for dynamic scale via ROUTE
DEF PRESS_SENSOR Transform {
  translation 0 2.7 0
  scale 1 1 1 # Default, will be routed
  children [ Shape { appearance Appearance { material USE SENSOR_MATERIAL } geometry Box { size 0.4 0.4 0.4 } } ]
}

# Base elements (standard)
DEF REACTOR_BASE Transform { translation 0 -2.7 0 children [ Shape { appearance Appearance { material USE BASE_MATERIAL } geometry Cylinder { height 0.4 radius 2.5 } } ] }
DEF REACTOR_BASE_DETAILED Transform { translation 0 -2.7 0 children [ Inline { url "https://raw.githubusercontent.com/Prince10107/ASimVR/main/base.wrl" } ] }
DEF FLANGE Transform { translation 0 -2.5 0 children [ Inline { url "https://raw.githubusercontent.com/Prince10107/ASimVR/main/flange.wrl" } ] }

# Viewpoint & Proximity Sensor (standard)
DEF INITIAL_VIEWPOINT Viewpoint { position 0 0 50.0 orientation 0 0 1 0 fieldOfView 0.785398 description "Initial View" }
DEF REACTOR_PROXIMITY ProximitySensor { size 10 10 10 center 0 0 0 }
DEF REACTOR_TRANSPARENCY_SWITCH Script { eventIn SFBool set_transparency eventOut SFFloat transparency_changed url "javascript: function set_transparency(value) { if (value) transparency_changed = 0.7; else transparency_changed = 0.0; }" }

# --- ROUTING STATEMENTS (CRITICAL for Simulink Connectivity) ---
# These connect the top-level eventIns (from Simulink) to the dynamic properties of your objects.
ROUTE set_reactor_color TO REACTOR_BODY_INSTANCE.reactor_color_input
ROUTE set_reactor_transparency TO REACTOR_BODY_INSTANCE.reactor_transparency_input

ROUTE set_liquid_level TO LIQUID.translation
ROUTE set_liquid_transparency TO LIQUID_MATERIAL_NODE.transparency

ROUTE set_agitator_rotation TO AGITATOR.rotation
ROUTE set_valve_knob_rotation TO VALVE_KNOB.rotation

ROUTE set_temp_sensor_scale TO TEMP_SENSOR.scale
ROUTE set_press_sensor_scale TO PRESS_SENSOR.scale
